# Overview

## 2. Database (MySQL)

### 2.1 設計資料庫結構

#### Database Schema Benefits
資料庫設計成六個表：Users、Posts、Likes、Comments、Follows 和 CommentLikes。  
這樣做有以下幾個好處。

1. **資料管理**
 - 將不同類型的資料儲存在專門的表中，可以大幅簡化資料的管理和維護。例如，使用者資訊、貼文內容、按讚資訊等分別儲存在不同的表中，有助於保持資料的有序性和結構的清晰性。

2. **效能優化**
 - 透過對每個表建立索引和外鍵，可以顯著提高資料檢索和操作的效率。例如，對使用者表的使用者名稱建立唯一索引，可以快速找到使用者資訊；透過外鍵關聯，可以有效率追蹤貼文和評論的關係。

3. **數據清晰**
 - 將不同類型的資料分離到不同的表中，避免了資料的混雜，保持了每個表的簡潔性。這使得資料庫結構更加直觀，資料查詢和操作也更加方便。

4. **擴展性**
 - 未來對資料庫結構進行擴展和優化。例如，可以根據需要添加新的表或字段，而不會影響現有的資料結構和功能。

5. **實現複雜查詢**
 - 將不同類型的資料分開存儲，實現複雜的 SQL 查詢。例如，可以透過聯結不同的表來查詢用戶的貼文、評論以及點讚信息，實現更加複雜的數據和應用功能。

#### 2.1.1 設計資料庫表

##### 數據庫模式設計

以下用兩種資料表舉例：Users 和 Posts，用於管理用戶和貼文。

##### 資料表結構設計

**資料表：Users**

用戶資料表儲存用戶訊息和帳號相關數據。

| 名稱	        | 數據類型	   | 約束條件		         | 描述					|
| ------------- | ------------ | ------------------- | -------------------	|
| Email         | VARCHAR(100) | NOT NULL, UNIQUE    | 信箱					|
| Password      | VARCHAR(100) | NULL                | 密碼(Bcrypt加密)		|
| Username      | VARCHAR(50)  | NOT NULL, UNIQUE    | 用戶名稱				|
| UserId        | INT          | NOT NULL			 | 用戶ID				|
| CreatedAt     | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP | 註冊時間			|
| ImgLink       | VARCHAR(255) | NULL                | 頭像連結				|
| Nickname      | VARCHAR(50)  | NULL                | 用戶暱稱				|
| login_type    | VARCHAR(20)  | NOT NULL, DEFAULT 'normal' | 登入類型		|

**索引**

- idx_username: 提高對用戶名稱的搜索效率。  


**資料表：Posts**

貼文表儲存用戶發布的貼文訊息

| 名稱	        | 數據類型	   | 約束條件		         | 描述					|
| ------------- | ------------ | ------------------- | -------------------	|
|PostId			| INT		   | NOT NULL			 | 貼文ID				|
|UserId			| INT		   | NOT NULL			 | 發布貼文的用戶			|
|Topic			| VARCHAR(100) | NOT NULL			 | 貼文主題				|
|Content		| TEXT  	   | NOT NULL			 | 貼文內容				|
|CreatedAt		| TIMESTAMP	   | DEFAULT CURRENT_TIMESTAMP | 貼文創建時間		|
|ImgLink		| VARCHAR(255) | NULL				 | 貼文圖片連結			|

外鍵
```sql
FOREIGN KEY (UserId) REFERENCES Users(UserId)
```
Posts外鍵指向Users，他們之間的關係是先有Users，才會有Posts。  
一個用戶可以有多篇貼文。


### 2.2 數據查詢、儲存數據

#### 2.2.1 數據查詢操作

查詢User最新的10篇貼文，包含貼文主題、貼文內容、貼文圖片連結。  
並且按照貼文創建順序，簡單舉例。

```sql
SELECT Topic, Content, ImgLink
FROM Posts
WHERE UserId = xxx
ORDER BY CreatedAt DESC
LIMIT 10;
```

#### 2.2.2 數據修改、儲存操作

發佈新貼文
```sql
INSERT INTO Posts (UserId, Topic, Content, ImgLink) 
VALUES (xxx, '自訂義主題', '貼文內容', '圖片連結');
```

修改貼文
```sql
UPDATE Posts SET Content = '修改好的貼文內容' 
WHERE PostId = xxx 
AND UserId = xxx
```

進階查詢多個table
```sql
SELECT 
  c.CommentId,
  u.Username,
  u.ImgLink,
  c.Content,
  c.CreatedAt,
  ( SELECT COUNT(*)
    FROM CommentLikes cl
    WHERE cl.CommentId = c.CommentId ) AS LikeCount,
  ( SELECT COUNT(*)
    FROM Comments subc
    WHERE subc.ParentCommentId = c.CommentId ) AS CommentCount,
  ucl.IsActive AS LikeStatus
FROM Comments c
INNER JOIN Users u ON c.UserId = u.UserId
LEFT JOIN CommentLikes cl ON c.CommentId = cl.CommentId
LEFT JOIN CommentLikes ucl ON c.CommentId = ucl.CommentId AND ucl.UserId = ?
WHERE c.PostId = ? AND c.ParentCommentId IS NULL
GROUP BY c.CommentId, u.Username, c.Content, c.CreatedAt
ORDER BY c.CreatedAt DESC
LIMIT 15 OFFSET ?
```

1. 資料規範化：
 - 將資料分成不同的表格有助於減少資料冗餘。例如，將使用者資訊儲存在 Users 表中，而評論資訊則儲存在 Comments 表中。這樣，當使用者資訊更新時，只需要更新一個地方，減少了資料不一致的風險。
2. 查詢效能最佳化：
 - 透過使用適當的索引和分錶設計，可以顯著提高查詢效能。例如，CommentLikes 表可以單獨統計每個評論的按讚數，而不必每次都掃描整個評論表。
3. 提高資料彈性：
 - 分錶設計使得資料結構更靈活，能夠適應業務需求的變化。例如，可以輕鬆地新增新的表來支援新的功能，而不需要大幅修改現有表結構。
4. 簡化維護：
 - 分錶設計使得資料維護更加簡單。每個表有明確的職責，修改和調試時可以更專注和有效率。
5. 增強安全性：
 - 透過分表，可以對不同類型的資料設定不同的權限，增強資料的安全性。例如，可以限制只有特定角色的使用者才能存取或修改 Likes 表的資料。
