# Overview

本篇介紹如何在應用程式中整合 GitHub 作為第三方登入系統。  
實現前端免註冊，並按下 GitHub 登入即可完成。省去傳統註冊/驗證流程。

### 註冊 GitHub OAuth 應用

1. 登入 [GitHub](https://github.com/) 並前往 [GitHub 開發者設置](https://github.com/settings/developers)。
2. 點擊 `New OAuth App` 以建立新的 OAuth 應用。
3. 填寫應用程式相關資訊：
    - **Application name**: 您應用程式的名稱
    - **Homepage URL**: 您應用程式的主頁 URL
    - **Authorization callback URL**: 當用戶成功授權後，GitHub 將重定向至此 URL，例如 `https://www.example.com/auth/github/callback`
4. 點擊 `Register application` 以完成註冊。
 - 完成註冊請保存好 Client ID ， Client secrets key 以便於前後端使用。
 **Client secrets key 請保存好，只會顯示第一次明碼，如果忘記或沒保存到只能在重複以上步驟。**
 
### 前端實作 GitHub 登入

 - 以下為簡單例子。使用 JavaScript 實作 GitHub 登入功能
```javascript
const github_login = async () => {
  const GITHUB_CONFIG = {
    clientID: 'clientID',
    redirectURI: 'Authorization callback URL',
    scope: 'user:email'
  };

  const authURL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientID}&redirect_uri=${GITHUB_CONFIG.redirectURI}&scope=user:email`;
  window.location.href = authURL;
};
```
 - clientID: 您在 GitHub 開發者設置中獲得的應用程式 Client ID。
 - redirectURI: 授權成功後，GitHub 將重定向到 URL (Authorization callback URL)。
 - scope: 請求的權限範圍。 user:email，表示請求訪問用戶的電子郵件地址。
```javascript
window.location.href = authURL;
```
 - 這一行將會把頁面，轉向到 GitHub 授權頁面。
 
授權成功後，GitHub 會導向到我們設定的 Authorization callback URL 頁面。  
在這個頁面可以拿到授權碼，然後向後端發送API並登入。
 - 將拿到授權 code 送到後端，並且通過後端驗證成功拿到 github 用戶授權資訊。
``` javascript
	const response = await fetch(`${apiBaseUrl}/githublogin`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          githubCode: code
        })
	});
```
 
### 後端實作 GitHub 授權碼請求

**設定 GitHub key 配置**
在'application.properties'設置 clientId, clientSecret。
```application
github.client.id=xxx
github.client.secret=xxx
```

後端拿到授權碼之後，再用授權碼去向 GitHub 索取 Token。  
 - 拿到 GitHub 用戶Email之後，可以在後端DB加入該帳戶，完成第三方登入。
```java
@PostMapping("/githublogin")
    public ResponseEntity<AuthResponse> githubLogin(@RequestBody User user) {
        String code = user.getGithubCode();
        String accessTokenResponse = getAccessToken(code);
        String accessToken = extractAccessToken(accessTokenResponse);

        GitHubUser gitHubUser = getUserInfo(accessToken);
        List<GitHubEmail> emails = getUserEmails(accessToken);
		//...到這裡驗證都完成，就算是第三方登入成功，之後就按照你的登入步驟。
	}
```
 - 使用授權碼獲取 Token 和其他用戶資訊。
``` java
private final String accessTokenUrl = "https://github.com/login/oauth/access_token";
    private final String github_user = "https://api.github.com/user";
    private final String github_email = "https://api.github.com/user/emails";

    @Autowired
    private RestTemplate restTemplate;

    public String getAccessToken(String code) {
        MultiValueMap<String, String> map = new LinkedMultiValueMap<>();
        map.add("client_id", clientId);
        map.add("client_secret", clientSecret);
        map.add("code", code);

        HttpHeaders headers = new HttpHeaders();
        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(map, headers);

        ResponseEntity<String> response = restTemplate.postForEntity(accessTokenUrl, request, String.class);
        if (response.getStatusCode() == HttpStatus.OK) {
            return response.getBody();
        }
		
        return null;
    }
	
	public List<GitHubEmail> getUserEmails(String accessToken) {
        HttpHeaders headers = new HttpHeaders();
        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));
        headers.set("Authorization", "Bearer " + accessToken);
        HttpEntity<String> entity = new HttpEntity<>("", headers);
        ResponseEntity<List<GitHubEmail>> response = restTemplate.exchange(github_email, HttpMethod.GET, entity, new ParameterizedTypeReference<List<GitHubEmail>>() {});
        if (response.getStatusCode() == HttpStatus.OK) {
            return response.getBody();
        }
        // 處理錯誤
        return null;
    }
```
 - 後端就能獲取到 GitHub 用戶授權的資訊了，能夠將資訊註冊到DB，實現用戶快速第三方登入。

 
### 完整流程
1. 前端點擊登入按鈕，跳轉頁面到 GitHub 授權頁面。
2. 用戶在授權頁面授權之後，GitHub 會將用戶重新跳轉到你設置的(Authorization callback URL)，並且附帶授權碼。
3. 前端將授權碼送到後端處理。
4. 後端利用授權碼向Github請求 Token ，再利用 Token 訪問 GitHub 帳號資訊。
 